# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

**arch-config** is a declarative system configuration management tool for Arch Linux, managed via the **dcli** tool. It manages host-specific and modular system package declarations, enabling reproducible system setups across multiple machines.

**Key Purpose**: Define and maintain system package lists declaratively, allowing users to sync configurations across different Arch Linux installations using dcli.

### dcli Integration

This repository is managed by [dcli](https://gitlab.com/theblackdon/arch-config) - a Rust-based declarative configuration management tool that brings NixOS-style package management to Arch Linux. All system synchronization, package management, and configuration updates are performed through dcli commands.

**What dcli does**:
- Defines entire system state in YAML files
- Organizes packages into reusable modules
- Syncs configurations across multiple machines
- Ensures reproducibility: identical configs produce identical systems

**dcli Dependencies** (required for full functionality):
- `yay` - AUR helper for package management
- `fzf` - Fuzzy finder for TUI interactions (search, module selection)
- `timeshift` - System backup tool for configuration backups
- `claude-code` - Claude Code CLI (AI assistant for code tasks)

**Integration Points**:
- `scripts/` - dcli hooks that run custom installation/setup logic
- `state/` - dcli-managed state directory (auto-generated, gitignored)
- `system-packages-{hostname}.yaml` - Auto-generated by dcli from merged configuration
- `hosts/` - Host-specific configurations read by dcli sync engine
- `modules/` - Reusable package modules processed by dcli

## Architecture

### Core Structure

- **hosts/** - Host-specific configurations (e.g., `computersloeber.yaml`)
  - Each host file defines which modules are enabled and host-specific packages
  - References a `description` field and lists `enabled_modules`
  - Can exclude packages via `exclude` field

- **modules/** - Reusable package modules
  - `base.yaml` - Core system packages installed on all hosts (kernel, firmware, window manager, audio, development tools)
  - Host-specific modules (e.g., `computer-sloeber.yaml`, `dwm.yaml`) - packages for particular setups
  - Each module has a `description` and `packages` list

- **scripts/** - Setup and installation scripts
  - `dwm.sh` - Downloads and builds DWM (Dynamic Window Manager) from suckless repository

- **config.yaml** - Pointer to the active host configuration (determines which host YAML is loaded)

- **state/** - Auto-generated state directory (gitignored)
  - Contains configuration backups managed by timeshift

### Configuration Flow

1. `config.yaml` points to the active host (e.g., `computersloeber`)
2. Host configuration (`hosts/computersloeber.yaml`) lists enabled modules and host-specific settings
3. Enabled modules pull in package lists from `modules/*.yaml`
4. Base packages from `modules/base.yaml` are always included
5. System merges all package lists and generates `system-packages-{hostname}.yaml` (auto-generated, gitignored)

## dcli Workflow

dcli is the primary interface for managing this configuration. When modifying package lists or host configurations, changes are applied through dcli commands.

**Main dcli Commands**:
```bash
dcli init                          # Initialize configuration structure
dcli sync                          # Reconcile system packages with configuration
dcli sync --dry-run               # Preview changes without applying them
dcli module enable/disable         # Activate or deactivate module groups
dcli search                        # Interactive package discovery with preview
dcli merge                         # Capture manually-installed packages into config
dcli validate                      # Check configuration integrity
dcli repo push/pull               # Synchronize configs across machines via git
```

**Typical workflow**:
1. Edit configuration files (hosts/*.yaml, modules/*.yaml)
2. Run `dcli sync --dry-run` to preview changes
3. Review the proposed package installations/removals
4. Run `dcli sync` to apply changes to the system
5. dcli merges configurations, generates system-packages-{hostname}.yaml
6. dcli executes package management (via yay/pacman) and runs scripts/ hooks

**Key dcli Features**:
- Configuration validation before applying changes
- Safety checks to prevent conflicts
- Automatic backups before/after sync operations
- Parallel module processing (default) or sequential (for repo dependencies)
- Scripts in `scripts/` are executed as dcli hooks (e.g., `dwm.sh` for window manager setup)
- Reproducible system setup: identical configurations produce identical systems

## Development Commands

### Viewing Configuration

```bash
# View the active host configuration
cat config.yaml

# View a specific host's setup
cat hosts/computersloeber.yaml

# View installed modules and packages
cat modules/base.yaml
cat modules/computer-sloeber.yaml
```

### Adding or Modifying Packages

1. **For all hosts**: Add to `modules/base.yaml`
2. **For specific host**: Add to `modules/computer-sloeber.yaml`
3. **For specific module**: Create or update a module YAML file
4. **To exclude packages**: Add to `exclude` list in `hosts/{hostname}.yaml`

### Managing Modules

- Enable a module: Add to `enabled_modules` list in host configuration
- Disable a module: Remove from `enabled_modules` list
- Create new module: Add `modules/{module-name}.yaml` with `description` and `packages` fields

### Setup Scripts

- `scripts/dwm.sh` - Handles DWM installation
  - Clones/pulls from suckless repository
  - Runs `make dwm` to build from source
  - Place custom build logic here
- `scripts/dotfiles-deploy.sh` - Deploys dotfiles via GNU stow
  - Symlinks configuration files from `dotfiles/` to home directory
  - Backs up existing conflicting files
  - Runs systemd service configuration
- `scripts/dotfiles-systemd.sh` - Enables systemd user services
  - Enables essential services (darkman, 1password, wallpaper)
  - Reloads systemd user daemon
- `scripts/secrets-decrypt.sh` - Unlocks and deploys secrets
  - Decrypts git-crypt encrypted files using GPG key
  - Deploys SSH keys and credentials to home directory
  - Sets correct file permissions (600 for private keys)

## Key Concepts

### Declarative Configuration

This is a **declarative** system - describe what packages should exist, not how to install them. The tooling handles the "how" (likely using pacman/yay).

### Auto-Generated Files

- `system-packages-{hostname}.yaml` - Auto-generated merged package list (do not edit)
- Files in `state/` - Auto-generated backups (do not commit)
- Gitignore these to keep the repo clean

### Backup Management

```yaml
config_backups:
  enabled: true      # Auto-backup on sync
  max_backups: 5     # Keep last 5 backups
backup_tool: timeshift
```

The system supports automatic configuration backups. Enable/disable in host configuration.

## Dotfiles Management

**dotfiles/** contains application configuration files that are deployed to the home directory.

**How it works**:
- Files are stored in `dotfiles/` mirroring home directory structure
- Deployed via GNU stow, creating symlinks (not copies)
- Version controlled in git for reproducibility
- Edited directly in place (symlinks are transparent)

**Key directories**:
- `dotfiles/.config/` - Application configs (xinitrc, alacritty, nvim, tmux, etc.)
- `dotfiles/.dwm/` - DWM window manager configuration and statusbar
- `dotfiles/.local/bin/` - Custom scripts and executables
- `dotfiles/.zshrc`, `.bashrc` - Shell configuration

**Workflow**:
1. Add dotfile to `dotfiles/` directory (maintain home directory structure)
2. Run `bash scripts/dotfiles-deploy.sh` to create symlinks
3. Edit via symlink: `vim ~/.zshrc` â†’ edits `dotfiles/.zshrc`
4. Commit changes: `git add dotfiles/` and `git commit`

**Deployment**: Run `dcli sync` (automatically calls `dotfiles-deploy.sh`)

**Documentation**: See [docs/DOTFILES.md](docs/DOTFILES.md) for detailed guide

## Secrets Management

**secrets/** contains encrypted files (SSH keys, credentials) managed by git-crypt.

**How it works**:
- SSH keys and tokens stored in `secrets/` directory
- Files marked in `.gitattributes` for encryption
- Encrypted with git-crypt using GPG keys
- Decrypted locally for deployment
- Only accessible to users with authorized GPG keys

**Key directories**:
- `secrets/ssh/` - SSH private key, public key, config (encrypted)
- `secrets/credentials/` - Application tokens and credentials (encrypted)

**Setup** (first time):
```bash
cd ~/.config/arch-config
git-crypt init                          # Initialize encryption
git-crypt add-gpg-user YOUR_GPG_KEY_ID # Add your GPG key
# Copy secrets and commit
```

**Deployment**: Run `dcli sync` (automatically calls `secrets-decrypt.sh`)

**Security**:
- SSH keys: 600 permissions, decrypted locally only
- Git view: Files appear encrypted in repository
- Access control: Only GPG key holders can decrypt
- History: Full git history available after unlock

**Documentation**: See [docs/SECRETS.md](docs/SECRETS.md) for detailed guide

## Bootstrap New Machine

New Arch Linux installations can be fully configured using the bootstrap process.

**Overview**:
1. Install git and base-devel
2. Import GPG key for decrypting secrets
3. Clone arch-config repository
4. Install dcli and dependencies
5. Run `dcli sync` to configure entire system

**Result**: System identical to computersloeber with all packages, dotfiles, and secrets deployed.

**Documentation**: See [bootstrap/README.md](bootstrap/README.md) for step-by-step guide

## Common Tasks

### Switching Between Hosts

1. Update `config.yaml`:
```yaml
host: computersloeber  # Change to desired host
```

2. Sync with dcli:
```bash
dcli sync --dry-run    # Preview changes
dcli sync              # Apply changes
```

### Adding a New Host

1. Create `hosts/new-host.yaml`:
```yaml
host: new-host
description: 'Machine description'
enabled_modules:
  - dwm
  - base
packages: []
exclude: []
```

2. Create host-specific module `modules/new-host.yaml` if needed

3. Update `config.yaml` to point to the new host

4. Initialize and sync:
```bash
dcli init              # Initialize on new machine
dcli sync --dry-run    # Preview changes
dcli sync              # Apply configuration
```

### Adding Packages to a Module

1. Edit the module file (e.g., `modules/base.yaml`)
2. Add package name(s) to the `packages:` list
3. Preview changes:
```bash
dcli sync --dry-run
```
4. Apply when ready:
```bash
dcli sync
```

### Installing Manually-Added Packages to Config

To capture packages you've manually installed into your configuration:
```bash
dcli merge              # Analyzes system and updates config files
```

### Including Shared Configurations

Hosts can import shared configurations:
```yaml
import:
  - hosts/shared/laptop-common.yaml
```

This allows DRY (Don't Repeat Yourself) across multiple host files.

### Enabling/Disabling Modules

```bash
dcli module enable dwm              # Enable a module
dcli module disable dwm             # Disable a module
dcli sync --dry-run                 # Preview the changes
dcli sync                           # Apply changes to system
```

## Package Management

### Dependencies

- **yay** - AUR helper (required for AUR package management)
- **fzf** - Fuzzy finder (required for TUI search/module selection)
- **timeshift** - System backup tool (required for backup commands)

### Key Installed Tools

**Development**:
- `git`, `neovim`, `jdk`, `jdk17-openjdk`, `android-tools`
- `direnv` - Environment variable management
- `claude-code` - Claude Code CLI

**System**:
- Window manager ecosystem: `dwm` (from suckless), `picom`, `rofi`, `xorg-*`
- Audio: `pipewire` and related audio servers
- Network: `networkmanager`, `bind`, `tcpdump`, `wakeonlan`
- Terminal: `zsh`, `tmux`, `tmate`, `alacritty`

**Utilities**:
- `lazydocker` - Docker/Compose terminal UI
- `barrier` - Keyboard/mouse sharing
- `darkman` - Automatic dark mode switching
- `autorandr` - Automatic screen layout management

## Configuration Backups

dcli automatically creates backups before and after sync operations. This is configured in the host file:

```yaml
config_backups:
  enabled: true      # Auto-backup on sync
  max_backups: 5     # Keep last 5 backups (0 = unlimited)

backup_tool: timeshift
```

Backups allow safe recovery if configuration changes cause issues. The backup tool (timeshift) handles filesystem snapshots.

## Important Notes

- **Use dcli for all system changes** - Always apply configurations through dcli, not manually
- **Preview before applying** - Always run `dcli sync --dry-run` to review changes
- **Do not edit auto-generated files** - `system-packages-{hostname}.yaml` is regenerated on dcli sync
- **Use declarative approach** - Modify YAML files, not the merged output
- **Keep gitignore clean** - State directory and auto-generated files should remain gitignored
- **Test module changes** - After modifying modules, verify the merged package list is correct before running dcli sync
- **Script execution** - Custom scripts in `scripts/` are executed as dcli hooks during sync operations
- **Backups before sync** - dcli creates automatic backups before applying changes, enabling safe rollback
